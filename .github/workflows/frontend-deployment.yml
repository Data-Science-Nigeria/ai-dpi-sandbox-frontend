name: Deploy Sandbox Frontend to Azure VM

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: sandbox-frontend-env

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Package source (exclude git + node_modules)
      - name: Create source tarball
        run: |
          tar --exclude='.git' --exclude='node_modules' -czf source.tgz .

      # Write SSH key
      - name: Prepare SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VM_SSH_KEY }}" > ~/.ssh/azurevm.key
          sed -i 's/\r$//' ~/.ssh/azurevm.key
          chmod 600 ~/.ssh/azurevm.key

      # Copy source to VM
      - name: Upload to VM
        run: scp -o StrictHostKeyChecking=no -i ~/.ssh/azurevm.key \
             source.tgz ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}:/tmp/source.tgz

      # Build on VM, flip symlink, restart service on :8080
      - name: Deploy on VM
        env:
          VM_PATH: ${{ secrets.VM_PATH }}              # e.g. /opt/nextapp
          SERVICE: ${{ secrets.SERVICE_NAME || 'sandbox-frontend' }}
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/azurevm.key \
            ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} 'bash -s' <<'REMOTE'
          set -euo pipefail
          BASE="${VM_PATH:-/opt/nextapp}"
          TS=$(date +%Y%m%d%H%M%S)
          NEW_REL="$BASE/releases/$TS"

          mkdir -p "$NEW_REL"
          tar -C "$NEW_REL" -xzf /tmp/source.tgz
          rm -f /tmp/source.tgz

          # Build as azureuser (your systemd user)
          sudo chown -R azureuser:azureuser "$BASE" "$NEW_REL"
          cd "$NEW_REL"
          sudo -u azureuser yarn --frozen-lockfile
          sudo -u azureuser yarn build
          test -d ".next" || { echo "Build failed: .next missing"; exit 1; }

          # Activate atomically
          ln -sfn "$NEW_REL" "$BASE/current"

          # Restart service on :8080
          sudo systemctl daemon-reload
          sudo systemctl restart "${SERVICE:-sandbox-frontend}"
          sudo systemctl --no-pager status "${SERVICE:-sandbox-frontend}" | sed -n '1,20p'

          # Quick health probe
          curl -sI http://127.0.0.1:8080 | head -n1 || true
